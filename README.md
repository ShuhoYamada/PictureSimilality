# 2次元形状類似度解析・可視化 Web システム

✅ 本リポジトリは、複数のTIFF画像（部品断面図等）を入力に、形状の**全体的類似度（Global）**、**局所差分（Local）**、**類似画像検索**、**クラスタリング**を可視化する Streamlit Web アプリケーションの実装です。

---

## 🔧 目次
- [特徴](#-特徴)
- [セットアップ](#-セットアップ)
- [使い方（簡易）](#-使い方簡易)
- [大量画像の処理](#-大量画像の処理)
- [コマンド一覧](#-コマンド一覧)
- [ファイル構成](#-ファイル構成)
- [注意点 / トラブルシューティング](#-注意点--トラブルシューティング)
- [開発 / テスト](#-開発--テスト)

---

## ✨ 特徴

### 解析機能
- **Global Map:** Huモーメントとフーリエ記述子を連結 → StandardScaler → MDS/t-SNE により 2D 埋め込みを可視化
- **Local Comparison:** 重心合わせ + Procrustes（Kabsch）／簡易ICP による位置合わせ → cKDTree ベースで点ごとの誤差を算出（Hausdorff / Chamfer）→ Plotly でヒートマップ可視化
- **類似画像検索:** 基準画像を選択すると、特徴量ベースで類似度の高い画像をランキング表示
- **クラスタリング:** K-means / DBSCAN / 階層的クラスタリングで形状を自動分類

### 形状対応
- **穴（内側輪郭）サポート:** 穴のある形状も正確に特徴量化（穴のHuモーメント補正、フーリエ記述子拡張）
- **島（穴の中の形状）検出:** 階層的な輪郭構造を適切に処理

### 大量画像対応
- **フォルダ指定入力:** 2000枚以上の画像もサーバー側で直接読み込み（ブラウザのタイムアウト回避）
- **解析ボタン方式:** アップロード後すぐに処理せず、ボタンクリックで開始
- **進捗バー表示:** 100枚ごとにリアルタイムで進捗を表示

### UI
- Streamlit で操作可能（複数ファイルアップロード / フォルダ指定、パラメータ調整、4タブ構成）

---

## 🧰 セットアップ

### macOS (conda)
```bash
conda create -n kido python=3.11
conda activate kido
pip install -r requirements.txt
```

### Windows (venv)
```powershell
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
```

> 補足: プレビュー画像を PNG 出力したい場合は `kaleido` を追加で入れてください。

---

## ▶️ 使い方（簡易）

### 1. アプリ起動
```bash
streamlit run app.py
```

### 2. 入力方法を選択
サイドバーで入力方法を選択:
- **ファイルアップロード:** 少量の画像（〜500枚）向け
- **フォルダ指定:** 大量画像（1000枚以上）向け。フォルダのフルパスを入力

### 3. パラメータ設定
- 閾値（0=Otsu自動）
- 近似精度（epsilon factor）
- リサンプリング点数
- 穴の検出ON/OFF
- フーリエ係数数
- 埋め込み手法（MDS/t-SNE）
- クラスタリング設定（オプション）

### 4. タブの使い分け

| タブ | 機能 | 使い方 |
|-----|------|-------|
| **Global Map** | 複数画像の2D埋め込み表示 | 「解析開始」→ マップ上でホバーしてファイル名確認 |
| **Single Image** | 単一画像の輪郭確認 | 画像を選択 →「解析開始」→ 輪郭を可視化 |
| **Local Comparison** | 2枚の画像の位置合わせ・差分 | 基準/比較画像を選択 →「解析開始」→ ヒートマップ表示 |
| **類似画像検索** | 類似形状のランキング | 「解析開始」→ 基準画像を選択 → TOP N を表示 |

---

## 📦 大量画像の処理

2000枚以上の画像を処理する場合の推奨設定:

### 1. フォルダ指定を使用
```
入力方法: フォルダ指定（大量画像向け）
画像フォルダのパス: /Users/username/images
```

### 2. 解析手順
1. フォルダパスを入力すると「✅ 2094枚の画像を検出」と表示
2. 各タブで「🔬 解析開始」ボタンをクリック
3. 進捗バーで処理状況を確認（100枚ごとに更新）
4. 完了後、結果が自動表示

### 3. メモリ節約Tips
- Global Mapでは埋め込み計算にサンプリングを適用
- 類似度マトリックスは最大100枚でヒートマップ表示（CSV出力は全件可能）

---

## ⛏ コマンド一覧
```bash
# アプリ起動
streamlit run app.py

# 簡易 HTTP サーバ（プレビュー表示）
python -m http.server --directory previews 8000
```

---

## 📁 ファイル構成
```
PictureSimilality/
├── app.py                 # Streamlit UI（4タブ構成）
├── src/
│   ├── __init__.py        # パッケージ初期化
│   ├── preprocessor.py    # 画像読み込み・2値化・輪郭抽出（穴対応）
│   ├── global_features.py # Hu, Fourier, クラスタリング, 類似検索
│   ├── local_analysis.py  # 重心合わせ / Procrustes / ICP
│   └── visualizer.py      # Plotly グラフ生成（穴・島の色分け表示）
├── requirements.txt       # 依存パッケージ
├── README.md
└── LICENSE
```

---

## ⚠️ 注意点 / トラブルシューティング

### 輪郭が検出できない場合
- 閾値（Threshold）を 0（Otsu）→ 手動に変更
- 画像を反転（白背景／黒背景の違い）して試す
- `num_points` を増やすと局所差が滑らかになるが計算量増加

### 大量画像でエラーが出る場合
- **AxiosError: Network Error** → フォルダ指定入力を使用
- 処理が固まる → 解析ボタン方式で手動開始に切り替え

### 穴のある形状が正しく認識されない場合
- 「穴の最小面積」パラメータを調整（小さな穴を除外）
- 穴が閉じているか確認（途切れていると検出されない）

### 距離の単位
出力はピクセル単位 (px) です。実際の長さ（mm など）に変換するには画像のスケール情報が必要です。

---

## 🧪 開発・テスト

### 今後の作業候補
- サンプル画像セットを `examples/` に追加してデモを簡易化
- `pytest` によるユニットテスト（主要関数）を追加
- 距離を mm 単位へ換算するための設定画面（スケール指定）

---

## ライセンス
MIT License - 詳細は [LICENSE](LICENSE) を参照

## 貢献
貢献は歓迎します。PR を送ってください。